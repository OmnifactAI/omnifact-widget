var OmnifactWidget=function(e){"use strict";class t{constructor(e){this.element=e,this.config={...t.defaults}}load(){return this._loadFromJsonScript(),this._loadFromAttributes(),this._validate(),this.config}_loadFromJsonScript(){const e=this.element.querySelector('script[type="application/json"]');if(e)try{const t=JSON.parse(e.textContent||"{}");Object.assign(this.config,this._normalizeConfig(t))}catch(e){console.error("[OmnifactWidget] Invalid JSON configuration:",e)}}_loadFromAttributes(){for(const[e,n]of Object.entries(t.attributeMap)){const s=this.element.getAttribute(e);null!==s&&(t.booleanAttributes.includes(n)?this.config[n]="false"!==s:this.config[n]=s)}}_normalizeConfig(e){const n={};for(const[s,o]of Object.entries(e)){const e=s.replace(/-([a-z])/g,(e,t)=>t.toUpperCase());t.booleanAttributes.includes(e)&&"string"==typeof o?n[e]="false"!==o:n[e]=o}return n}_validate(){const e=[];this.config.endpointUrl||e.push("endpoint-url is required"),this.config.endpointId||e.push("endpoint-id is required"),e.length>0&&console.warn("[OmnifactWidget] Configuration warnings:",e.join(", "))}set(e,n){e in t.defaults&&(this.config[e]=n)}get(){return{...this.config}}}t.defaults={endpointUrl:"",endpointId:"",apiKey:"",position:"bottom-right",title:"Chat with us",welcomeMessage:"Hello! How can I help you today?",primaryColor:"#6366f1",secondaryColor:"#818cf8",backgroundColor:"#ffffff",textColor:"#1f2937",storageKey:"omnifact-chat",enablePersistence:!0,enableInlineSources:!1,enableAgenticWorkflow:!1,debug:!1},t.attributeMap={"endpoint-url":"endpointUrl","endpoint-id":"endpointId","api-key":"apiKey",position:"position",title:"title","welcome-message":"welcomeMessage","primary-color":"primaryColor","secondary-color":"secondaryColor","background-color":"backgroundColor","text-color":"textColor","storage-key":"storageKey","enable-persistence":"enablePersistence","enable-inline-sources":"enableInlineSources","enable-agentic-workflow":"enableAgenticWorkflow",debug:"debug"},t.booleanAttributes=["enablePersistence","enableInlineSources","enableAgenticWorkflow","debug"];class n{constructor(e="omnifact-chat"){this.storageKey=e}getState(){try{const e=localStorage.getItem(this.storageKey);if(!e)return this._getDefaultState();const t=JSON.parse(e);return this._isSessionValid(t)?t:(this.clearState(),this._getDefaultState())}catch(e){return console.warn("[OmnifactWidget] Failed to load chat state:",e),this._getDefaultState()}}saveState(e){try{const t=e.messages.slice(-n.MAX_MESSAGES).map(e=>({...e,content:e.content?.slice(0,n.MAX_MESSAGE_LENGTH)||""})),s={sessionId:e.sessionId,messages:t,lastUpdated:Date.now(),version:1};localStorage.setItem(this.storageKey,JSON.stringify(s))}catch(t){t instanceof Error&&"QuotaExceededError"===t.name?this._handleQuotaExceeded(e):console.warn("[OmnifactWidget] Failed to save chat state:",t)}}clearState(){try{localStorage.removeItem(this.storageKey)}catch(e){console.warn("[OmnifactWidget] Failed to clear chat state:",e)}}_isSessionValid(e){return!!e.lastUpdated&&Date.now()-e.lastUpdated<n.SESSION_TIMEOUT}_getDefaultState(){return{sessionId:this._generateSessionId(),messages:[]}}_generateSessionId(){return"undefined"!=typeof crypto&&crypto.randomUUID?"session-"+crypto.randomUUID():"session-"+Math.random().toString(36).substring(2,11)+Math.random().toString(36).substring(2,11)}_handleQuotaExceeded(e){try{const t=e.messages.slice(-Math.floor(n.MAX_MESSAGES/2)),s={sessionId:e.sessionId,messages:t,lastUpdated:Date.now(),version:1};localStorage.setItem(this.storageKey,JSON.stringify(s))}catch(e){console.warn("[OmnifactWidget] Failed to save chat state after cleanup:",e)}}}n.MAX_MESSAGES=100,n.MAX_MESSAGE_LENGTH=1e4,n.SESSION_TIMEOUT=864e5;class s{constructor(e){this.baseUrl=e.endpointUrl,this.endpointId=e.endpointId,this.apiKey=e.apiKey,this.enableInlineSources=e.enableInlineSources||!1,this.enableAgenticWorkflow=e.enableAgenticWorkflow||!1,this.debug=e.debug||!1}async sendMessage(e,t=!0){const n=`${this.baseUrl}/v1/endpoints/${this.endpointId}/chat`,s={"Content-Type":"application/json"};this.apiKey&&(s["X-API-Key"]=this.apiKey),this.enableInlineSources&&(s["omnifact-enable-inline-sources"]="true"),this.enableAgenticWorkflow&&(s["omnifact-enable-agentic-workflow"]="true"),this.debug&&(console.log("[API Debug] Request URL:",n),console.log("[API Debug] Request headers:",s),console.log("[API Debug] Request body:",{messages:e,streaming:t}));const i=await fetch(n,{method:"POST",headers:s,body:JSON.stringify({messages:e.map(e=>({role:e.role,content:e.content})),streaming:t})});if(!i.ok){const e=await i.text().catch(()=>"Unknown error");throw new o(`API request failed: ${i.status}`,i.status,e)}return t?i:i.json()}updateConfig(e){e.endpointUrl&&(this.baseUrl=e.endpointUrl),e.endpointId&&(this.endpointId=e.endpointId),e.apiKey&&(this.apiKey=e.apiKey),void 0!==e.enableInlineSources&&(this.enableInlineSources=e.enableInlineSources),void 0!==e.enableAgenticWorkflow&&(this.enableAgenticWorkflow=e.enableAgenticWorkflow),void 0!==e.debug&&(this.debug=e.debug)}}class o extends Error{constructor(e,t,n){super(e),this.name="ApiError",this.status=t,this.responseText=n}}class i{constructor(){this.debug=!1}setDebug(e){this.debug=e}_log(e,t){this.debug&&console.log(`[SSE Debug] ${e}:`,t)}async processStream(e,t){const{onChunk:n,onReferences:s,onSource:o,onComplete:i,onError:r}=t;this.debug&&console.log("[SSE Debug] Starting stream processing...");const a=e.body.getReader(),c=new TextDecoder;let l="",d=null,h="",u=null,g=null;const p=[];try{for(;;){const{done:e,value:t}=await a.read();if(e)break;l+=c.decode(t,{stream:!0});const r=l.split("\n");l=r.pop()||"";for(const e of r){const t=e.trim();if(t)if(t.startsWith("event: "))d=t.slice(7).trim(),this._log("Event",d);else if(!t.startsWith("id: ")&&t.startsWith("data: ")){const e=t.slice(6);if("assistant_write"===d)try{const t=JSON.parse(e);this._log("assistant_write",t),t.content&&(u=t.messageId||u,h+=t.content,n&&n(t.content,h,u))}catch{this._log("assistant_write (raw)",e),h+=e,n&&n(e,h,u)}else if("references"===d)try{const t=JSON.parse(e);this._log("references",t),g=t,s&&s(t)}catch(e){console.warn("[SSEHandler] Failed to parse references:",e)}else if("message_source"===d)try{const t=JSON.parse(e);this._log("message_source",t),p.push(t),o&&o(t)}catch(e){console.warn("[SSEHandler] Failed to parse source:",e)}else{if("done"===d){const e={content:h,messageId:u,references:g,sources:p.length>0?p:null};return this._log("done",e),i&&i(e),e}if("error"===d){this._log("error",e);try{const t=JSON.parse(e);throw new Error(t.message||"Stream error")}catch(t){if(t instanceof Error&&"Stream error"!==t.message)throw t;throw new Error(e||"Stream error")}}else this._log(`unknown event (${d})`,e)}}}}const e={content:h,messageId:u,references:g,sources:p.length>0?p:null};return i&&i(e),e}catch(e){throw r&&e instanceof Error&&r(e),e}}}class r extends HTMLElement{constructor(){super(),this._state={isOpen:!1,messages:[],isTyping:!1,sessionId:null},this._config=null,this._storage=null,this._apiClient=null,this._sseHandler=new i,this._bubble=null,this._window=null,this._messageList=null,this._chatInput=null,this._typingIndicator=null,this.attachShadow({mode:"open"})}static get observedAttributes(){return["endpoint-url","endpoint-id","api-key","position","title","welcome-message","primary-color","secondary-color","background-color","text-color","enable-inline-sources","enable-agentic-workflow","debug"]}connectedCallback(){const e=new t(this);this._config=e.load(),this._storage=new n(this._config.storageKey),this._apiClient=new s(this._config),this._sseHandler.setDebug(this._config.debug),this._config.debug&&(window.omnifactDebug=!0),this._initializeSession(),this.render(),this._setupComponentReferences(),this._applyTheme(),this._renderMessages(),this._setupEventListeners()}attributeChangedCallback(e,n,s){if(!this.isConnected||n===s)return;const o=new t(this);this._config=o.load(),this._apiClient&&this._apiClient.updateConfig(this._config),this._applyTheme(),"title"===e&&this._window&&this._config&&this._window.setAttribute("title",this._config.title),"position"===e&&this._updatePosition(),"debug"===e&&this._sseHandler&&this._config&&this._sseHandler.setDebug(this._config.debug)}_initializeSession(){if(this._config&&this._storage){if(this._config.enablePersistence){const e=this._storage.getState();this._state.sessionId=e.sessionId,this._state.messages=e.messages||[]}else this._state.sessionId=this._generateSessionId(),this._state.messages=[];0===this._state.messages.length&&this._config.welcomeMessage&&this._state.messages.push({id:"welcome",role:"assistant",content:this._config.welcomeMessage,timestamp:Date.now(),isWelcome:!0})}}_generateSessionId(){return"undefined"!=typeof crypto&&crypto.randomUUID?"session-"+crypto.randomUUID():"session-"+Math.random().toString(36).substring(2,11)}_setupComponentReferences(){this.shadowRoot&&(customElements.upgrade(this.shadowRoot),this._bubble=this.shadowRoot.querySelector("omnifact-chat-bubble"),this._window=this.shadowRoot.querySelector("omnifact-chat-window"),this._messageList=this.shadowRoot.querySelector("omnifact-message-list"),this._chatInput=this.shadowRoot.querySelector("omnifact-chat-input"),this._typingIndicator=this.shadowRoot.querySelector("omnifact-typing-indicator"))}_applyTheme(){if(!this._config)return;const{primaryColor:e,secondaryColor:t,backgroundColor:n,textColor:s}=this._config;this.style.setProperty("--omnifact-primary",e),this.style.setProperty("--omnifact-secondary",t),this.style.setProperty("--omnifact-background",n),this.style.setProperty("--omnifact-text",s),this._bubble&&void 0!==this._bubble.primaryColor&&(this._bubble.primaryColor=e),this._window&&"function"==typeof this._window.setTheme&&this._window.setTheme(this._config),this._messageList&&"function"==typeof this._messageList.setTheme&&this._messageList.setTheme(this._config),this._chatInput&&"function"==typeof this._chatInput.setTheme&&this._chatInput.setTheme(this._config),this._typingIndicator&&"function"==typeof this._typingIndicator.setTheme&&this._typingIndicator.setTheme(this._config)}_updatePosition(){if(!this._config)return;const e=this._config.position;this._window&&this._window.setAttribute("position",e)}_setupEventListeners(){this._bubble?.addEventListener("toggle",()=>{this._toggleChat()}),this._window?.addEventListener("close",()=>{this._closeChat()}),this._window?.addEventListener("clear",()=>{this.clearHistory()}),this._chatInput?.addEventListener("send",e=>{this._sendMessage(e.detail.message)})}_toggleChat(){this._state.isOpen=!this._state.isOpen,this._updateChatVisibility()}open(){this._state.isOpen=!0,this._updateChatVisibility()}_closeChat(){this._state.isOpen=!1,this._updateChatVisibility()}close(){this._closeChat()}_updateChatVisibility(){const e=this._state.isOpen;e?(this._window?.removeAttribute("hidden"),this._bubble&&(this._bubble.hasUnread=!1),setTimeout(()=>{this._chatInput?.focus(),this._messageList?.scrollToBottom(!1)},100)):this._window?.setAttribute("hidden",""),this._bubble&&(this._bubble.isOpen=e)}_renderMessages(){if(!this._messageList)return;this._messageList.querySelectorAll("omnifact-message-item").forEach(e=>e.remove());for(const e of this._state.messages)this._renderMessage(e);setTimeout(()=>{this._messageList?.scrollToBottom(!1)},50)}_renderMessage(e,t=!1){if(!this._messageList)return null;const n=document.createElement("omnifact-message-item");return n.setAttribute("role",e.role),n.setAttribute("data-id",e.id),n.setAttribute("data-content",e.content||""),t&&n.setAttribute("streaming",""),this._messageList.appendChild(n),Promise.resolve().then(()=>{e.sources&&(n.sources=e.sources),e.references&&(n.references=e.references),n.content=e.content}),n}async _sendMessage(e){if(!e.trim()||this._state.isTyping||!this._apiClient)return;const t={id:this._generateMessageId(),role:"user",content:e.trim(),timestamp:Date.now()};this._state.messages.push(t),this._renderMessage(t),this._chatInput&&(this._chatInput.disabled=!0),this._state.isTyping=!0,this._typingIndicator?.show(),setTimeout(()=>{this._messageList?.scrollToBottom()},50);const n=this._state.messages.filter(e=>!e.isWelcome).map(e=>({role:e.role,content:e.content}));try{const e={id:this._generateMessageId(),role:"assistant",content:"",timestamp:Date.now()},t=await this._apiClient.sendMessage(n,!0);this._typingIndicator?.hide(),this._state.messages.push(e);const s=this._renderMessage(e,!0),o=!0;await this._sseHandler.processStream(t,{onChunk:(t,n,i)=>{e.content=n,i&&(e.id=i),s?.appendContent(t),o&&this._messageList?.isNearBottom()&&this._messageList.scrollToBottom()},onReferences:t=>{e.references=t,s&&(s.references=t)},onSource:t=>{e.sources||(e.sources=[]),e.sources.push(t),s&&(s.sources=e.sources)},onComplete:t=>{e.content=t.content,t.messageId&&(e.id=t.messageId),t.references&&(e.references=t.references,s&&(s.references=t.references)),t.sources&&(e.sources=t.sources,s&&(s.sources=t.sources)),s?.removeAttribute("streaming"),s&&(s.content=t.content),this._saveState()},onError:e=>{console.error("[OmnifactWidget] Stream error:",e)}})}catch(e){console.error("[OmnifactWidget] Failed to send message:",e);const t={id:this._generateMessageId(),role:"assistant",content:"Sorry, I encountered an error. Please try again.",timestamp:Date.now(),isError:!0};this._state.messages.push(t),this._renderMessage(t)}finally{this._chatInput&&(this._chatInput.disabled=!1),this._state.isTyping=!1,this._typingIndicator?.hide(),this._chatInput?.focus(),this._saveState()}}_generateMessageId(){return"undefined"!=typeof crypto&&crypto.randomUUID?"msg-"+crypto.randomUUID():"msg-"+Math.random().toString(36).substring(2,11)}_saveState(){this._config?.enablePersistence&&this._storage&&this._storage.saveState({sessionId:this._state.sessionId,messages:this._state.messages})}clearHistory(){this._state.messages=[],this._config?.welcomeMessage&&this._state.messages.push({id:"welcome",role:"assistant",content:this._config.welcomeMessage,timestamp:Date.now(),isWelcome:!0}),this._storage?.clearState(),this._renderMessages()}sendMessage(e){this._state.isOpen||this.open(),this._sendMessage(e)}render(){if(!this.shadowRoot||!this._config)return;const e=this._config.position||"bottom-right";this.shadowRoot.innerHTML=`\n      <style>\n        :host {\n          --omnifact-primary: ${this._config.primaryColor};\n          --omnifact-secondary: ${this._config.secondaryColor};\n          --omnifact-background: ${this._config.backgroundColor};\n          --omnifact-text: ${this._config.textColor};\n\n          position: fixed;\n          z-index: 9999;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;\n        }\n\n        :host([position="bottom-right"]),\n        :host(:not([position])) {\n          bottom: 20px;\n          right: 20px;\n        }\n\n        :host([position="bottom-left"]) {\n          bottom: 20px;\n          left: 20px;\n        }\n\n        .container {\n          position: relative;\n        }\n      </style>\n\n      <div class="container">\n        <omnifact-chat-window\n          title="${this._config.title}"\n          hidden\n          position="${e}"\n        >\n          <omnifact-message-list></omnifact-message-list>\n          <omnifact-typing-indicator hidden></omnifact-typing-indicator>\n          <omnifact-chat-input></omnifact-chat-input>\n        </omnifact-chat-window>\n\n        <omnifact-chat-bubble></omnifact-chat-bubble>\n      </div>\n    `,this.setAttribute("position",e)}}class a extends HTMLElement{constructor(){super(),this._hasUnread=!1,this._isOpen=!1,this.attachShadow({mode:"open"})}connectedCallback(){this.render(),this._setupEventListeners()}set hasUnread(e){this._hasUnread=e;const t=this.shadowRoot?.querySelector(".bubble");t&&t.classList.toggle("pulse",e)}get hasUnread(){return this._hasUnread}set primaryColor(e){this.style.setProperty("--bubble-color",e)}set isOpen(e){this._isOpen=e;const t=this.shadowRoot?.querySelector(".chat-icon"),n=this.shadowRoot?.querySelector(".close-icon");t&&n&&(t.style.display=e?"none":"block",n.style.display=e?"block":"none")}get isOpen(){return this._isOpen}_setupEventListeners(){const e=this.shadowRoot?.querySelector(".bubble");e?.addEventListener("click",()=>{this.dispatchEvent(new CustomEvent("toggle",{bubbles:!0,composed:!0}))})}render(){this.shadowRoot&&(this.shadowRoot.innerHTML='\n      <style>\n        :host {\n          --bubble-color: #6366f1;\n          display: block;\n        }\n\n        .bubble {\n          width: 60px;\n          height: 60px;\n          border-radius: 50%;\n          background: var(--bubble-color);\n          border: none;\n          cursor: pointer;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n          transition: transform 0.2s ease, box-shadow 0.2s ease;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          position: relative;\n          padding: 0;\n        }\n\n        .bubble:hover {\n          transform: scale(1.05);\n          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);\n        }\n\n        .bubble:active {\n          transform: scale(0.95);\n        }\n\n        .bubble.pulse::after {\n          content: \'\';\n          position: absolute;\n          width: 100%;\n          height: 100%;\n          border-radius: 50%;\n          background: var(--bubble-color);\n          animation: pulse 2s infinite;\n          z-index: -1;\n        }\n\n        @keyframes pulse {\n          0% {\n            transform: scale(1);\n            opacity: 0.7;\n          }\n          100% {\n            transform: scale(1.5);\n            opacity: 0;\n          }\n        }\n\n        .icon {\n          width: 28px;\n          height: 28px;\n          fill: white;\n        }\n\n        .close-icon {\n          display: none;\n        }\n      </style>\n\n      <button class="bubble" aria-label="Open chat">\n        <svg class="icon chat-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/>\n          <path d="M7 9h10v2H7zm0-3h10v2H7z"/>\n        </svg>\n        <svg class="icon close-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n        </svg>\n      </button>\n    ')}}class c extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}static get observedAttributes(){return["title","hidden"]}connectedCallback(){this.render(),this._setupEventListeners()}attributeChangedCallback(e,t,n){if("title"===e&&this.isConnected){const e=this.shadowRoot?.querySelector(".header-title");e&&(e.textContent=n||"Chat")}}setTheme(e){e.primaryColor&&this.style.setProperty("--primary-color",e.primaryColor),e.backgroundColor&&this.style.setProperty("--background-color",e.backgroundColor),e.textColor&&this.style.setProperty("--text-color",e.textColor)}_setupEventListeners(){const e=this.shadowRoot?.querySelector(".close-btn");e?.addEventListener("click",()=>{this.dispatchEvent(new CustomEvent("close",{bubbles:!0,composed:!0}))});const t=this.shadowRoot?.querySelector(".clear-btn");t?.addEventListener("click",()=>{this.dispatchEvent(new CustomEvent("clear",{bubbles:!0,composed:!0}))})}render(){if(!this.shadowRoot)return;const e=this.getAttribute("title")||"Chat";this.shadowRoot.innerHTML=`\n      <style>\n        :host {\n          --primary-color: #6366f1;\n          --background-color: #ffffff;\n          --text-color: #1f2937;\n          --border-color: #e5e7eb;\n\n          display: flex;\n          flex-direction: column;\n          position: absolute;\n          bottom: 76px;\n          right: 0;\n          width: 380px;\n          height: 600px;\n          max-height: calc(100vh - 100px);\n          max-width: calc(100vw - 40px);\n          background: var(--background-color);\n          border-radius: 16px;\n          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);\n          overflow: hidden;\n          transform-origin: bottom right;\n          transition: transform 0.3s ease, opacity 0.3s ease;\n        }\n\n        :host([hidden]) {\n          display: flex;\n          transform: scale(0.9) translateY(10px);\n          opacity: 0;\n          pointer-events: none;\n        }\n\n        :host([position="bottom-left"]) {\n          right: auto;\n          left: 0;\n          transform-origin: bottom left;\n        }\n\n        .header {\n          display: flex;\n          align-items: center;\n          justify-content: space-between;\n          padding: 16px 20px;\n          background: var(--primary-color);\n          color: white;\n          flex-shrink: 0;\n        }\n\n        .header-title {\n          font-size: 16px;\n          font-weight: 600;\n          margin: 0;\n        }\n\n        .header-actions {\n          display: flex;\n          gap: 4px;\n          align-items: center;\n        }\n\n        .header-btn {\n          background: none;\n          border: none;\n          cursor: pointer;\n          padding: 6px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          border-radius: 4px;\n          transition: background-color 0.2s;\n        }\n\n        .header-btn:hover {\n          background: rgba(255, 255, 255, 0.2);\n        }\n\n        .header-btn svg {\n          width: 18px;\n          height: 18px;\n          fill: white;\n        }\n\n        .content {\n          display: flex;\n          flex-direction: column;\n          flex: 1;\n          overflow: hidden;\n        }\n\n        ::slotted(omnifact-message-list) {\n          flex: 1;\n          min-height: 0;\n        }\n\n        ::slotted(omnifact-typing-indicator) {\n          flex-shrink: 0;\n        }\n\n        ::slotted(omnifact-chat-input) {\n          flex-shrink: 0;\n        }\n      </style>\n\n      <div class="header">\n        <h2 class="header-title">${e}</h2>\n        <div class="header-actions">\n          <button class="header-btn clear-btn" aria-label="Clear chat history" title="Clear chat">\n            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>\n            </svg>\n          </button>\n          <button class="header-btn close-btn" aria-label="Close chat">\n            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n            </svg>\n          </button>\n        </div>\n      </div>\n\n      <div class="content">\n        <slot></slot>\n      </div>\n    `}}class l extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){this.render()}scrollToBottom(e=!0){const t=this.shadowRoot?.querySelector(".messages");t&&(e?t.scrollTo({top:t.scrollHeight,behavior:"smooth"}):t.scrollTop=t.scrollHeight)}isNearBottom(){const e=this.shadowRoot?.querySelector(".messages");if(!e)return!0;return e.scrollHeight-e.scrollTop-e.clientHeight<100}setTheme(e){e.backgroundColor&&this.style.setProperty("--background-color",e.backgroundColor)}render(){this.shadowRoot&&(this.shadowRoot.innerHTML='\n      <style>\n        :host {\n          --background-color: #ffffff;\n          display: flex;\n          flex-direction: column;\n          flex: 1;\n          min-height: 0;\n          overflow: hidden;\n        }\n\n        .messages {\n          flex: 1;\n          overflow-y: auto;\n          padding: 16px;\n          display: flex;\n          flex-direction: column;\n          gap: 12px;\n          background: var(--background-color);\n        }\n\n        .messages::-webkit-scrollbar {\n          width: 6px;\n        }\n\n        .messages::-webkit-scrollbar-track {\n          background: transparent;\n        }\n\n        .messages::-webkit-scrollbar-thumb {\n          background: #d1d5db;\n          border-radius: 3px;\n        }\n\n        .messages::-webkit-scrollbar-thumb:hover {\n          background: #9ca3af;\n        }\n\n        ::slotted(*) {\n          flex-shrink: 0;\n        }\n      </style>\n\n      <div class="messages">\n        <slot></slot>\n      </div>\n    ')}}class d{constructor(e={}){this.options={sanitize:!0,linkTarget:"_blank",...e}}render(e){if(!e)return"";let t=this.options.sanitize?this._escapeHtml(e):e;return t=this._renderCodeBlocks(t),t=this._renderInlineCode(t),t=this._renderHeaders(t),t=this._renderBold(t),t=this._renderItalic(t),t=this._renderLinks(t),t=this._renderLists(t),t=this._renderLineBreaks(t),t}_escapeHtml(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,e=>t[e])}_renderCodeBlocks(e){return e.replace(/```(\w*)\n([\s\S]*?)```/g,(e,t,n)=>`<pre><code${t?` class="language-${t}"`:""}>${n.trim()}</code></pre>`)}_renderInlineCode(e){return e.replace(/`([^`]+)`/g,"<code>$1</code>")}_renderHeaders(e){return e.replace(/^### (.+)$/gm,"<h4>$1</h4>").replace(/^## (.+)$/gm,"<h3>$1</h3>").replace(/^# (.+)$/gm,"<h2>$1</h2>")}_renderBold(e){return e.replace(/\*\*(.+?)\*\*|__(.+?)__/g,(e,t,n)=>`<strong>${t||n}</strong>`)}_renderItalic(e){return e.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g,"<em>$1</em>")}_renderLinks(e){const t=this.options.linkTarget;return e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,`<a href="$2" target="${t}" rel="noopener noreferrer">$1</a>`)}_renderLists(e){const t=e.split("\n"),n=[];let s=!1;for(const e of t){const t=e.match(/^[\-\*]\s+(.+)$/);t?(s||(n.push("<ul>"),s=!0),n.push(`<li>${t[1]}</li>`)):(s&&(n.push("</ul>"),s=!1),n.push(e))}return s&&n.push("</ul>"),n.join("\n")}_renderLineBreaks(e){return e.split("\n").map((e,t,n)=>{if(e.startsWith("<pre>")||e.startsWith("<ul>")||e.startsWith("</pre>")||e.startsWith("</ul>")||e.startsWith("<li>")||e.startsWith("<h"))return e;const s=n[t+1];return s&&!s.startsWith("<")&&e.trim()?e+"<br>":e}).join("\n")}}class h extends HTMLElement{constructor(){super(),this._content="",this._references=null,this._sources=null,this._markdownRenderer=new d,this.attachShadow({mode:"open"})}static get observedAttributes(){return["role","streaming","data-content"]}connectedCallback(){const e=this.getAttribute("data-content");e&&!this._content&&(this._content=e),this.render()}attributeChangedCallback(e,t,n){if(this.isConnected)if("streaming"===e){const e=this.shadowRoot?.querySelector(".message");e&&(null!==n?e.classList.add("streaming"):e.classList.remove("streaming"))}else this.render()}set content(e){this._content=e||"",this._updateContent()}get content(){return this._content}appendContent(e){this._content+=e,this._updateContent()}set references(e){window.omnifactDebug&&console.log("[MessageItem Debug] Setting references:",e),this._references=e,this._updateReferences()}get references(){return this._references}set sources(e){window.omnifactDebug&&console.log("[MessageItem Debug] Setting sources:",e),this._sources=e,this._updateReferences()}get sources(){return this._sources}setTheme(e){e.primaryColor&&this.style.setProperty("--primary-color",e.primaryColor),e.textColor&&this.style.setProperty("--text-color",e.textColor)}_updateContent(){if(!this.shadowRoot)return;const e=this.shadowRoot.querySelector(".content");if(e){let t=this._markdownRenderer.render(this._content);this._sources&&this._sources.length>0&&(t=this._processCitations(t)),e.innerHTML=t}}_processCitations(e){if(!this._sources)return e;const t=new Map;return this._sources.forEach((e,n)=>{t.set(e.sourceId,n+1)}),e.replace(/:cite\[([^\]]+)\]/g,(e,n)=>{const s=t.get(n);return s?`<sup class="citation" data-source="${n}">[${s}]</sup>`:e})}_updateReferences(){if(!this.shadowRoot)return void(window.omnifactDebug&&console.log("[MessageItem Debug] _updateReferences: no shadowRoot"));let e=this.shadowRoot.querySelector(".references");if(!e){const t=this.shadowRoot.querySelector(".bubble");window.omnifactDebug&&console.log("[MessageItem Debug] _updateReferences: bubble=",t),t&&(e=document.createElement("div"),e.className="references",t.appendChild(e))}if(e)if(this._sources&&this._sources.length>0){const t=this._renderSources(this._sources);window.omnifactDebug&&console.log("[MessageItem Debug] _updateReferences: rendering sources, html length=",t.length),e.innerHTML=t}else this._references?e.innerHTML=this._renderLegacyReferences(this._references):e.innerHTML="";else window.omnifactDebug&&console.log("[MessageItem Debug] _updateReferences: no refsEl, aborting")}_renderSources(e){if(!e||0===e.length)return"";return`<div class="references-title">Sources</div>${e.map((e,t)=>{const n=e.documentName||"Document",s=e.page?` (p. ${e.page})`:"";return`<div class="reference-item">\n        <span class="reference-num">[${t+1}]</span>\n        <span class="reference-name">${this._escapeHtml(n)}${s}</span>\n      </div>`}).join("")}`}_renderLegacyReferences(e){if(!e)return"";const t=(e.references||e).documents||[];if(0===t.length)return"";return`<div class="references-title">Sources</div>${t.map((e,t)=>{const n=e.name||"Document",s=e.metadata||{},o=s.url||s.source_url;return o?`<div class="reference-item">\n          <span class="reference-num">[${t+1}]</span>\n          <a href="${this._escapeHtml(o)}" target="_blank" rel="noopener noreferrer" class="reference-link">${this._escapeHtml(n)}</a>\n        </div>`:`<div class="reference-item">\n        <span class="reference-num">[${t+1}]</span>\n        <span class="reference-name">${this._escapeHtml(n)}</span>\n      </div>`}).join("")}`}_escapeHtml(e){if(!e)return"";const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return String(e).replace(/[&<>"']/g,e=>t[e])}render(){if(!this.shadowRoot)return;const e=this.getAttribute("role")||"user",t=this.hasAttribute("streaming");this.shadowRoot.innerHTML=`\n      <style>\n        :host {\n          --primary-color: var(--omnifact-primary, #6366f1);\n          --text-color: var(--omnifact-text, #1f2937);\n          --user-bg: var(--primary-color);\n          --assistant-bg: #f3f4f6;\n          display: block;\n        }\n\n        .message {\n          display: flex;\n          gap: 8px;\n          max-width: 85%;\n        }\n\n        .message.user {\n          margin-left: auto;\n          flex-direction: row-reverse;\n        }\n\n        .message.assistant {\n          margin-right: auto;\n        }\n\n        .avatar {\n          width: 32px;\n          height: 32px;\n          border-radius: 50%;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          flex-shrink: 0;\n          font-size: 14px;\n          background: #e5e7eb;\n        }\n\n        .message.user .avatar {\n          background: var(--user-bg);\n          color: white;\n        }\n\n        .bubble {\n          padding: 10px 14px;\n          border-radius: 16px;\n          line-height: 1.5;\n          word-wrap: break-word;\n          overflow-wrap: break-word;\n        }\n\n        .message.user .bubble {\n          background: var(--user-bg);\n          color: white;\n          border-bottom-right-radius: 4px;\n        }\n\n        .message.assistant .bubble {\n          background: var(--assistant-bg);\n          color: var(--text-color);\n          border-bottom-left-radius: 4px;\n        }\n\n        .content {\n          font-size: 14px;\n        }\n\n        /* Markdown styles */\n        .content h2, .content h3, .content h4 {\n          margin: 0.5em 0 0.25em;\n          font-weight: 600;\n        }\n\n        .content h2 { font-size: 1.2em; }\n        .content h3 { font-size: 1.1em; }\n        .content h4 { font-size: 1em; }\n\n        .content p {\n          margin: 0.25em 0;\n        }\n\n        .content code {\n          background: rgba(0, 0, 0, 0.08);\n          padding: 0.1em 0.3em;\n          border-radius: 3px;\n          font-family: 'Fira Code', 'Consolas', monospace;\n          font-size: 0.9em;\n        }\n\n        .message.user .content code {\n          background: rgba(255, 255, 255, 0.2);\n        }\n\n        .content pre {\n          background: #1f2937;\n          color: #f3f4f6;\n          padding: 10px 12px;\n          border-radius: 8px;\n          overflow-x: auto;\n          margin: 0.5em 0;\n          font-size: 13px;\n        }\n\n        .content pre code {\n          background: none;\n          padding: 0;\n          color: inherit;\n        }\n\n        .content ul {\n          margin: 0.5em 0;\n          padding-left: 1.25em;\n        }\n\n        .content li {\n          margin: 0.2em 0;\n        }\n\n        .content a {\n          color: inherit;\n          text-decoration: underline;\n        }\n\n        .content strong {\n          font-weight: 600;\n        }\n\n        .content em {\n          font-style: italic;\n        }\n\n        /* Streaming cursor */\n        .streaming .content::after {\n          content: '\\25AE';\n          animation: blink 1s infinite;\n          margin-left: 2px;\n        }\n\n        @keyframes blink {\n          0%, 50% { opacity: 1; }\n          51%, 100% { opacity: 0; }\n        }\n\n        /* Citations */\n        .citation {\n          color: var(--primary-color);\n          cursor: pointer;\n          font-size: 0.8em;\n        }\n\n        .citation:hover {\n          text-decoration: underline;\n        }\n\n        /* References section */\n        .references {\n          margin-top: 10px;\n          padding-top: 10px;\n          border-top: 1px solid rgba(0, 0, 0, 0.1);\n          font-size: 12px;\n        }\n\n        .references-title {\n          font-weight: 600;\n          margin-bottom: 6px;\n          color: var(--text-color);\n          opacity: 0.7;\n        }\n\n        .reference-item {\n          display: flex;\n          gap: 6px;\n          margin-bottom: 4px;\n          align-items: flex-start;\n        }\n\n        .reference-num {\n          color: var(--primary-color);\n          font-weight: 500;\n          flex-shrink: 0;\n        }\n\n        .reference-name {\n          color: var(--text-color);\n          opacity: 0.8;\n          overflow: hidden;\n          text-overflow: ellipsis;\n          white-space: nowrap;\n          max-width: 200px;\n        }\n\n        .reference-link {\n          color: var(--primary-color);\n          text-decoration: none;\n          overflow: hidden;\n          text-overflow: ellipsis;\n          white-space: nowrap;\n          max-width: 200px;\n          display: inline-block;\n        }\n\n        .reference-link:hover {\n          text-decoration: underline;\n        }\n      </style>\n\n      <div class="message ${e} ${t?"streaming":""}">\n        <div class="avatar">${"user"===e?"&#128100;":"&#129302;"}</div>\n        <div class="bubble">\n          <div class="content">${this._markdownRenderer.render(this._content)}</div>\n        </div>\n      </div>\n    `}}class u extends HTMLElement{constructor(){super(),this._disabled=!1,this.attachShadow({mode:"open"})}static get observedAttributes(){return["disabled","placeholder"]}connectedCallback(){this.render(),this._setupEventListeners()}attributeChangedCallback(e,t,n){if(this.isConnected)if("disabled"===e)this._disabled=null!==n,this._updateDisabledState();else if("placeholder"===e){const e=this.shadowRoot?.querySelector("textarea");e&&(e.placeholder=n||"Type a message...")}}set disabled(e){this._disabled=e,e?this.setAttribute("disabled",""):this.removeAttribute("disabled"),this._updateDisabledState()}get disabled(){return this._disabled}focus(){const e=this.shadowRoot?.querySelector("textarea");e&&e.focus()}clear(){const e=this.shadowRoot?.querySelector("textarea");e&&(e.value="",this._adjustHeight(e))}setTheme(e){e.primaryColor&&this.style.setProperty("--primary-color",e.primaryColor),e.backgroundColor&&this.style.setProperty("--background-color",e.backgroundColor),e.textColor&&this.style.setProperty("--text-color",e.textColor)}_updateDisabledState(){const e=this.shadowRoot?.querySelector("textarea"),t=this.shadowRoot?.querySelector("button");e&&(e.disabled=this._disabled),t&&(t.disabled=this._disabled)}_setupEventListeners(){const e=this.shadowRoot?.querySelector("textarea"),t=this.shadowRoot?.querySelector("button");e?.addEventListener("input",()=>{e&&this._adjustHeight(e)}),e?.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this._send())}),t?.addEventListener("click",()=>{this._send()})}_adjustHeight(e){e.style.height="auto";e.style.height=Math.min(e.scrollHeight,120)+"px"}_send(){if(this._disabled)return;const e=this.shadowRoot?.querySelector("textarea"),t=e?.value.trim();t&&(this.dispatchEvent(new CustomEvent("send",{bubbles:!0,composed:!0,detail:{message:t}})),e&&(e.value="",this._adjustHeight(e)))}render(){if(!this.shadowRoot)return;const e=this.getAttribute("placeholder")||"Type a message...";this.shadowRoot.innerHTML=`\n      <style>\n        :host {\n          --primary-color: #6366f1;\n          --background-color: #ffffff;\n          --text-color: #1f2937;\n          --border-color: #e5e7eb;\n          display: block;\n          padding: 12px 16px;\n          background: var(--background-color);\n          border-top: 1px solid var(--border-color);\n        }\n\n        .input-container {\n          display: flex;\n          gap: 8px;\n          align-items: flex-end;\n        }\n\n        textarea {\n          flex: 1;\n          resize: none;\n          border: 1px solid var(--border-color);\n          border-radius: 20px;\n          padding: 10px 16px;\n          font-size: 14px;\n          font-family: inherit;\n          line-height: 1.4;\n          max-height: 120px;\n          min-height: 40px;\n          height: 40px;\n          background: var(--background-color);\n          color: var(--text-color);\n          outline: none;\n          transition: border-color 0.2s;\n        }\n\n        textarea:focus {\n          border-color: var(--primary-color);\n        }\n\n        textarea:disabled {\n          background: #f9fafb;\n          cursor: not-allowed;\n        }\n\n        textarea::placeholder {\n          color: #9ca3af;\n        }\n\n        button {\n          width: 40px;\n          height: 40px;\n          border-radius: 50%;\n          border: none;\n          background: var(--primary-color);\n          cursor: pointer;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          transition: transform 0.2s, background-color 0.2s;\n          flex-shrink: 0;\n        }\n\n        button:hover:not(:disabled) {\n          transform: scale(1.05);\n        }\n\n        button:active:not(:disabled) {\n          transform: scale(0.95);\n        }\n\n        button:disabled {\n          background: #d1d5db;\n          cursor: not-allowed;\n        }\n\n        button svg {\n          width: 20px;\n          height: 20px;\n          fill: white;\n        }\n      </style>\n\n      <div class="input-container">\n        <textarea\n          placeholder="${e}"\n          rows="1"\n          ${this._disabled?"disabled":""}\n        ></textarea>\n        <button\n          type="button"\n          aria-label="Send message"\n          ${this._disabled?"disabled":""}\n        >\n          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>\n          </svg>\n        </button>\n      </div>\n    `}}class g extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){this.render()}show(){this.removeAttribute("hidden")}hide(){this.setAttribute("hidden","")}setTheme(e){e.primaryColor&&this.style.setProperty("--dot-color",e.primaryColor)}render(){this.shadowRoot&&(this.shadowRoot.innerHTML='\n      <style>\n        :host {\n          --dot-color: #6366f1;\n          display: flex;\n          align-items: center;\n          gap: 8px;\n          padding: 8px 0;\n        }\n\n        :host([hidden]) {\n          display: none;\n        }\n\n        .avatar {\n          width: 32px;\n          height: 32px;\n          border-radius: 50%;\n          background: #e5e7eb;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: 14px;\n          flex-shrink: 0;\n        }\n\n        .dots {\n          display: flex;\n          gap: 4px;\n          padding: 12px 16px;\n          background: #f3f4f6;\n          border-radius: 16px;\n          border-bottom-left-radius: 4px;\n        }\n\n        .dot {\n          width: 8px;\n          height: 8px;\n          border-radius: 50%;\n          background: var(--dot-color);\n          opacity: 0.4;\n          animation: bounce 1.4s infinite ease-in-out;\n        }\n\n        .dot:nth-child(1) {\n          animation-delay: 0s;\n        }\n\n        .dot:nth-child(2) {\n          animation-delay: 0.2s;\n        }\n\n        .dot:nth-child(3) {\n          animation-delay: 0.4s;\n        }\n\n        @keyframes bounce {\n          0%, 80%, 100% {\n            transform: translateY(0);\n            opacity: 0.4;\n          }\n          40% {\n            transform: translateY(-6px);\n            opacity: 1;\n          }\n        }\n      </style>\n\n      <div class="avatar">&#129302;</div>\n      <div class="dots">\n        <div class="dot"></div>\n        <div class="dot"></div>\n        <div class="dot"></div>\n      </div>\n    ')}}
/**
     * Omnifact Chat Widget
     * Embeddable AI chat widget for Omnifact endpoints.
     *
     * @license MIT
     */const p=(e,t)=>{customElements.get(e)||customElements.define(e,t)};return p("omnifact-chat-widget",r),p("omnifact-chat-bubble",a),p("omnifact-chat-window",c),p("omnifact-message-list",l),p("omnifact-message-item",h),p("omnifact-chat-input",u),p("omnifact-typing-indicator",g),console.log("[OmnifactWidget] Initialized"),e.ApiClient=s,e.ChatBubble=a,e.ChatInput=u,e.ChatWindow=c,e.ConfigManager=t,e.MarkdownRenderer=d,e.MessageItem=h,e.MessageList=l,e.OmnifactChatWidget=r,e.SSEHandler=i,e.StorageService=n,e.TypingIndicator=g,e.default=r,Object.defineProperty(e,"__esModule",{value:!0}),e}({});
